<!-- eslint-disable @angular-eslint/template/eqeqeq -->
<app-breadcrumb-menu [items_menu]="items_menu" [home]="home"></app-breadcrumb-menu>


<div class="grid animation-duration-500 box">
    <div class="col-12">
        <div class="card">
            <div class="row">
                
                <div class="md:col-2 p-fluid">
                    <h6>{{ GetLanguage("f_start_date") }}</h6> 
                    <input
                        pInputText
                        id="dateStart"
                        class="text-center font-bold mr-2"
                        type="date"
                        [(ngModel)]="dateStart"
                    /> 
                </div>
                <div class="md:col-2 p-fluid">
                    <h6>{{ GetLanguage("f_end_date") }}</h6> 
                    <input
                        pInputText
                        id="dateEnd"
                        class="text-center font-bold mr-2"
                        type="date"
                        [(ngModel)]="dateEnd"
                    /> 
                </div>
                <div class="md:col-2" *ngIf="userProfile.employee_type_id != 7">
                    <h6>{{ GetLanguage("f_manager") }}</h6>
                    <!-- [multiSelect]="true" -->
                    <app-control-employee-list  
                        (outValue)="selectASM($event)"
                        [project_id]="project_id"
                        [placeholder]="GetLanguage('f_select_manager')"
                        [disabled]="
                            userProfile.employee_type_id == 8 ? true : false
                        "
                        [itemManagerCode]="
                            userProfile.employee_type_id == 8
                                ? userProfile.employee_id
                                : 0
                        "
                    ></app-control-employee-list>
                </div>
<!-- [multiSelect]="true" -->
                <div class="md:col-2" *ngIf="userProfile.employee_type_id != 7">
                    <h6>{{ GetLanguage("f_employee") }}</h6>
                    <app-control-employee-list  
                        (outValue)="selectSS($event)"
                        [project_id]="project_id"
                        [placeholder]="GetLanguage('lb_select_employee')"
                        [employee_type_id]="'7'"
                    ></app-control-employee-list>
                </div>

                <div class="md:col-2" >
                    <h6>{{ GetLanguage("f_position") }}</h6>
                    <app-control-position (outValue)="selectPosition($event)" [multiSelect]="true" (outClear)="clearSelectPosition($event)" > </app-control-position>
                </div> 

            </div>
        </div>
    </div>
</div>



<div class="grid">
    <div class="col-12">
        <div class="row">
            <p-toolbar>
                <div class="p-toolbar-group-left flex flex-wrap">
                    <button pButton type="button "  [label]="GetLanguage('action.filter')"  [loading]="isLoading_Filter" icon="pi pi-search"
                        (click)="filterTable(1)" class="p-button-sm mr-2 mt-2"></button>
                    <!-- listEmployee && listEmployee.length > 0 && -->
                     <!-- {{itemsData|json}} -->
                   <p-splitButton  *ngIf="checkUserCUS() == false &&  itemsData && itemsData.length > 0"
                            [label]="GetLanguage('action.rawdata')"  icon="pi pi-file-export"  styleClass="p-button-sm mr-2 mt-2"  [model]="itemsData"
                        ></p-splitButton> 
                        
                    <i class="pi pi-bars p-toolbar-separator"></i>

                    <button pButton type="button" pTooltip="Show Filter" pStyleClass=".box" enterClass="hidden"
                        enterActiveClass="fadeinup" (click)="ShowHideFiter()" tooltipPosition="top" icon="pi pi-eye"
                        class="p-button-success mr-2 mt-2" [ngStyle]="{
                            display: showFiter == 1 ? 'none' : 'flex'
                        }"></button>

                    <button pButton type="button" pTooltip="Hide Filter" (click)="ShowHideFiter()" tooltipPosition="top"
                        icon="pi pi-eye-slash" class="p-button-warning mr-2 mt-2" pStyleClass=".box"
                        leaveActiveClass="fadeoutup" leaveToClass="hidden" [ngStyle]="{
                            display: showFiter == 0 ? 'none' : 'flex'
                        }"></button>
                </div>
            </p-toolbar>
        </div>
    </div>
</div>

  

<div class="grid animation-duration-500 box2" >
    <div class="col-12">
        <div class="row">
            <!-- [tableStyle]="{ 'min-width': '50rem' }" -->
            <p-table
                rowGroupMode="subheader"
                groupRowsBy="manager_name"
                [columns]="cols"
                [value]="listEmployee" 
                styleClass="p-datatable-gridlines"
                [scrollable]="true"
            >
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <!-- pFrozenColumn -->
                        <th  
                            class="text-center w-1rem"
                            [ngStyle]="{
                                color: col.color,
                                background: col.backgroup_color,
                            }" 
                            [style]="col && (  col.field == 'employee_code' || col.field == 'employee_name' || col.field == 'position' )
                            ? 'width: 30%': ''"

                            *ngFor="let col of columns"
                        >
                            {{ col.header }} 
                            <!-- <label>{{col.field}}</label> -->
                        </th>
                    </tr>
                </ng-template>

                <ng-template
                    pTemplate="groupheader"
                    let-rowData
                    let-columns="columns"
                >
                    <tr pRowGroupHeader>
                        <!-- pFrozenColumn -->
                        <td colspan="2">
                            <span class="font-bold ml-2 mr-2">{{
                                rowData.manager_name
                            }}</span>
                        </td>
                        <ng-container
                            *ngFor="let col of columns; let i = index"
                        >
                            <td
                                [ngStyle]="{ background: col.backgroup_color }"
                                *ngIf="i >= 2"
                            ></td>
                        </ng-container>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rowData let-columns="columns">
                    <tr>
                        <!-- pFrozenColumn -->
                        <td
                            [ngStyle]="{ background: col.backgroup_color }"
                            *ngFor="let col of columns"
                            class="text-center"
                        >
                            <label class="text-center">{{
                                rowData[col.field]
                            }}</label>
                            
                            <button   
                                (click)="showdata(col.type, rowData.data)"
                                pButton
                                *ngIf="
                                    col.type > 0 &&
                                    GetData(
                                        col.type,
                                        rowData.data,
                                        rowData.result
                                    ) != 0
                                " 
                                [class]="colorButton" 
                                style="font-size: 105%; background-color: white;"
                                 > 
                                 {{
                                    GetData(
                                        col.type,
                                        rowData.data,
                                        rowData.result
                                    )
                                }} 
                                </button> 

                            <label
                                *ngIf="
                                    col.field != 'employee_code' &&
                                    col.field != 'employee_name' &&
                                    col.field != 'position' &&
                                    col.type > 0 &&
                                    GetData(
                                        col.type,
                                        rowData.data,
                                        rowData.result
                                    ) == 0
                                "
                            > 
                                <i  *ngIf="false"
                                    (click)=" 
                                        showAddPlan(
                                            rowData.employee_id,
                                            rowData.employee_code,
                                            rowData.employee_name,
                                            col.type,
                                            1
                                        )
                                    "
                                    class="pi pi-plus-circle"
                                    style="font-size: 1.1rem"
                                ></i>
                            </label>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            <p-paginator
                (onPageChange)="onPageChange1($event)"
                [first]="first1"
                [rows]="rows1"
                [totalRecords]="TotalRowNumber"
                [rowsPerPageOptions]="[10, 20, 30]"
            ></p-paginator>
        </div>
    </div>
</div>


<p-dialog
    [(visible)]="addPlanModal"
    [style]="{ width: '450px' }"
    header="Details Plan"
    [modal]="true"
    styleClass="p-fluid"
>
    <ng-template pTemplate="content">
        <div class="field" class="text-center">
            <!-- <span class="font-bold">Employee: </span> -->
            <label class="text-center"
                ><span class="font-bold" style="color: green"
                    >[{{ plan.employee_id }}]</span
                >
                -
                {{ plan.employee_code }}
                - {{ plan.employee_name }}</label
            >
        </div>

        <div class="field">
            <label for="date" class="font-bold"
                >Date<span class="font-bold" style="color: red"> *</span></label
            >
            <p-calendar
                inputId="date"
                [(ngModel)]="plan.date"
                selectionMode="range"
                placeholder="dd/mm/yy - dd/mm/yy"
                appendTo="body"
                dateFormat="dd/mm/yy"
                [readonlyInput]="true"
                [showButtonBar]="true"
                [minDate]="minDate"
                [maxDate]="maxDate"
            ></p-calendar>
        </div>

        <div class="field">
            <label for="shop" class="font-bold"
                >Shop<span class="font-bold" style="color: red"> *</span></label
            >
            <input
                type="text"
                pInputText
                [(ngModel)]="plan.shops"
                placeholder="SHOPCODE01 SHOPCODE02"
            />
        </div>

        <div class="field">
            <label for="shift" class="font-bold"
                >Shift<span class="font-bold" style="color: red">
                    *</span
                ></label
            >
            <app-control-shifts
                [style]="{ minWidth: '100%' }"
                (outValue)="selectAddShift($event)"
            ></app-control-shifts>
        </div>

        <div class="field col-3">
            <p-button
                (click)="op.toggle($event)"
                icon="pi pi-clock-o"
                label="Time"
                class="flex align-items-center"
            />
            <p-overlayPanel #op>
                <div class="flex flex-column gap-3 w-25rem">
                    <div class="row">
                        <div class="flex-auto col-5">
                            <label
                                for="calendar-timeonly"
                                class="font-bold block mb-2"
                            >
                                From time
                            </label>
                            <p-calendar
                                inputId="calendar-timeonly"
                                [(ngModel)]="from_time"
                                [timeOnly]="true"
                            />
                        </div>
                        <div class="flex-auto col-5">
                            <label
                                for="calendar-timeonly"
                                class="font-bold block mb-2"
                            >
                                To time
                            </label>
                            <p-calendar
                                inputId="calendar-timeonly"
                                [(ngModel)]="to_time"
                                [timeOnly]="true"
                            />
                        </div>
                    </div>
                </div>
            </p-overlayPanel>
        </div>
    </ng-template>

    <!-- <ng-template pTemplate="footer">
        <button
            pButton
            pRipple
            label="Cancel"
            icon="pi pi-times"
            class="p-button-text"
            (click)="hideDialog()"
        ></button>
        <button
            pButton
            pRipple
            label="Remove"
            icon="pi pi-trash"
            class="p-button-text"
            (click)="saveAddPlan('remove')"
        ></button>
        <button
            pButton
            pRipple
            label="Add"
            icon="pi pi-check"
            class="p-button-text"
            (click)="saveAddPlan('create')"
        ></button>
    </ng-template> -->
</p-dialog>

<p-dialog
    header="List Shop"
    [(visible)]="planModal"
    [modal]="true"
    showEffect="fade "
    [style]="{ width: '60vw' }"
    [breakpoints]="{ '960px': '75vw' }"
>
    <div class="flex justify-content-end px-4 align-item-center gap-3" *ngIf="false">
        <div class="flex justify-content-end align-items-center gap-2">
            <div class="p-input-icon-left flex flex-column gap-2">
                <button
                    pButton
                    pRipple
                    label="Action"
                    icon="pi pi-sitemap"
                    class="p-button-text mb-2 mt-2"
                    (click)="showDetail(2)"
                ></button>
            </div>
        </div>
    </div>

    <p-table
        [value]="listdetailplan"
        [tableStyle]="{ 'min-width': '50rem' }"
        dataKey="id"
    >
        <ng-template pTemplate="header">
            <tr>
                <th class="text-center">#</th>
                <th class="text-center">Code</th>
                <th class="text-center">Name</th>
                <th class="text-center">Address</th>
                <th class="text-center">Shift</th>
                <th class="text-center">Time</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-expanded="expanded">
            <tr>
                <td class="text-center"> 
                    <button
                        *ngIf="item.result && item.result.length > 0"
                        type="button"
                        pButton
                        pRipple
                        [pRowToggler]="item"
                        class="p-button-text p-button-rounded p-button-plain"
                        [icon]="
                            expanded
                                ? 'pi pi-chevron-down'
                                : 'pi pi-chevron-right'
                        "
                    ></button>
                </td>

                <td class="font-bold" style="color: green">
                    {{ item.shop_code }}
                </td>
                <td>{{ item.shop_name }}</td>
                <td>{{ item.shop_address }}</td>
                <td class="text-center">{{ item.shift_code }}</td>
                <td>{{ item.plan_time }}</td>
            </tr>
        </ng-template>

        <ng-template pTemplate="rowexpansion" let-item colspan="5">
            <tr>
                <td colspan="7">
                    <div class="p-3">
                        <p-carousel
                            [value]="item.result"
                            [numVisible]="3"
                            [numScroll]="3"
                            [circular]="false"
                        >
                            <p-tag
                                [value]="item.report_id"
                                [severity]="getSeverity(item.report_id)"
                            >
                            </p-tag
                            ><span>{{ item.UUID }}</span>

                            <ng-template let-item pTemplate="item">
                                <div
                                    class="border-1 surface-border border-round m-2 text-center py-5 px-3"
                                [pTooltip]="item.toolTip"
                                    tooltipPosition="top"
                                >
                                    <div class="mb-3">
                                        <!-- {{item.countRow|json}} -->
                                        <!--  style="height: 5%;width: 15%;" -->
                                        <img
                                            [src]="item.atd_photo"
                                            [alt]="item.atd_type"
                                            class="shadow-2"
                                            [style]="item.countRow > 1 ? 'height: 5%;width: 30%;' : 'height: 5%;width: 15%;'" 
                                            (click)="openImage(item.index)"
                                        />
                                    </div>
                                    <div>
                                        <h6 class="mb-1">
                                            {{ item.atd_time }}
                                        </h6>
                                        <p-tag
                                            [value]="item.atd_type"
                                            [severity]="
                                                getSeverity(item.atd_type)
                                            "
                                        ></p-tag>
                                        <div
                                            class="mt-5 flex align-items-center justify-content-center gap-2"
                                        >
                                            MAP
                                            <p-image
                                                *ngIf="
                                                    getKey(item.atd_type) == 1
                                                "
                                                (click)="
                                                    mapPopup(
                                                        item.latitude,
                                                        item.longitude
                                                    )
                                                "
                                                src="/assets/demo/images/works/marker_red.png"
                                                alt="Image"
                                                width="20px"
                                            ></p-image>

                                            <p-image
                                                *ngIf="
                                                    getKey(item.atd_type) == 2
                                                "
                                                (click)="
                                                    mapPopup(
                                                        item.latitude,
                                                        item.longitude
                                                    )
                                                "
                                                src="/assets/demo/images/works/marker_blue.png"
                                                alt="Image"
                                                width="20px"
                                            ></p-image>

                                            <p-image
                                                *ngIf="
                                                    getKey(item.atd_type) == 3
                                                "
                                                (click)="
                                                    mapPopup(
                                                        item.latitude,
                                                        item.longitude
                                                    )
                                                "
                                                src="/assets/demo/images/works/home.png"
                                                alt="Image"
                                                width="20px"
                                            >
                                            </p-image>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </p-carousel>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <ng-template pTemplate="footer" class="p-toolbar-group-right">
    </ng-template>
</p-dialog>

<p-dialog
    header="Notification"
    [(visible)]="display"
    [modal]="true"
    showEffect="fade"
    [style]="{ width: '30vw' }"
    [breakpoints]="{ '960px': '75vw' }"
>
    <p class="line-height-3 m-1">
        {{ message }}
    </p>
    <ng-template pTemplate="footer" class="p-toolbar-group-right">
        <button
            pButton
            icon="pi pi-check "
            (click)="OK()"
            label="Ok"
            class="p-button-outlined float-right"
            style="margin-right: 0%"
        ></button>
    </ng-template>
</p-dialog>
<p-toast />
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>
